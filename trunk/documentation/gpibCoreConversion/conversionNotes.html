<?xml version="1.0" encoding="iso-8859-1"?>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
  <title>No title</title>
  <meta name="generator" content="amaya 8.5, see http://www.w3.org/Amaya/" />
</head>

<body>
<h1 align="center">Updating devCommonGpib instrument support to ASYN</h1>

<h2 align="center">Eric Norum, May 11, 2004</h2>

<h2>1. Create instrument support development area</h2>
<ol>
  <li>Make a directory in modules/instrument/ for your instrument.</li>
  <li>'cd' to the directory created in the previous step and create a set of
    instrument support files by running the makeAsynSupport.pl script:
    <p><em>&nbsp;&nbsp;&lt;asynTop&gt;</em>/bin/<em>&lt;EpicsHostArch&gt;</em>/makeAsynSupport.pl
    -t instrument <em>&lt;InstName&gt;</em></p>
    <p>for example:</p>
    <p>&nbsp;&nbsp;/usr/local/EPICS/modules/soft/asyn/bin/linux-x86/makeAsynSupport.pl
    -t instrument Keithley196</p>
  </li>
  <li>Edit configure/RELEASE and set the ASYN and EPICS_BASE values to to the
    location of these packages on your system.</li>
  <li>Replace src/drv<em>&lt;InstName&gt;</em>.c with your existing
    instrument support.</li>
  <li>Replace src/drv<em>&lt;InstName&gt;</em>.dbd with your existing
    instrument support.</li>
  <li>Replace src/drv<em>&lt;InstName&gt;</em>.db with your existing
    instrument support, if any.</li>
</ol>

<h2>2. Modify instrument support C source file</h2>
A side-by-side display of the results of applying the following changes to a
support file for a simple instrument can be found <a
href="devKeithley196.c.diff.html">here</a>.
<ol>
  <li>Remove all <span style="font-family: courier">#include</span> lines
    except <span style="font-family: courier; font-size: 12pt">#include
    &lt;devCommonGpib.h&gt;</span>.</li>
  <li>Add <span style="font-family: courier; font-size: 12pt">#include
    &lt;devGpib.h&gt;</span> after <span
    style="font-family: courier; font-size: 12pt">#include
    &lt;devCommonGpib.h&gt;</span>.</li>
  <li>Ensure that there is a definition for <span
    style="font-family: courier">DSET_AI</span>, even if the device has no
    analog-in records.</li>
  <li>Remove any <span style="font-family: courier">DSET_</span><span
    style="font-style: italic">xxx</span> structure initializations.</li>
  <li>Remove any <span
    style="font-style: italic; font-size: 12pt">xxx</span><span
    style="font-family: courier; font-size: 12pt">Debug</span>
  definitions.</li>
  <li>Change the value of the <span
    style="font-family: courier; font-size: 12pt">TIME_WINDOW</span> macro
    from 1/60th of a second units to seconds.</li>
  <li>Change the <span
    style="font-family: courier; font-size: 12pt">DMA_TIME</span> macro to
    <span style="font-family: courier; font-size: 12pt">TIMEOUT</span> and
    its value from 1/60th of a second units to seconds.</li>
  <li>Modify the command table entries:
  <ul>
  <li>Change the end-of-string value (the last element) of
    each command from -1 to NULL or from a single character
    constant to a string constant:
    <table border="1">
      <tbody>
        <tr>
          <td align="center" colspan="2">Convert</td>
        </tr>
        <tr>
          <td align="center">From</td>
          <td align="center">To</td>
        </tr>
        <tr>
          <td align="center"><span style="font-family: courier">-1</span></td>
          <td align="center"><span style="font-family: courier">NULL</span></td>
        </tr>
        <tr>
          <td align="center"><span style="font-family: courier">'\r'</span></td>
          <td align="center"><span style="font-family: courier">"\r"</span></td>
        </tr>
      </tbody>
    </table></li>
    <li>Remove any <span style="font-family: courier">GPIBEOS</span>
    from the command type (the second element) of each command. Input end-of-string
    checking is now enabled by the presence of a non-NULL end-of-string value.</li>
  </ul>
  </li>
  <li>Change the name of the device-support initialization function to <span
    style="font-family: courier; font-size: 12pt">init_ai</span>.</li>
  <li>Remove from the device-support initialization function any calls to
    <span
    style="font-family: courier; font-size: 12pt">devGpibLib_init()</span>.
    Simply return 0 from the device-support initialization function.</li>
  <li>Initialize only the following parameters shown below in the
    device-support initialization function. The device-support initialization
    function should then appear like:
    <pre>    static long init_ai(int parm)
    {
        if (parm) {
            devSupParms.name = "<span style="font-weight: bold; font-size: 14pt">your device's name</span>";
            devSupParms.gpibCmds = gpibCmds;
            devSupParms.numparams = NUMPARAMS;
            devSupParms.timeWindow = TIME_WINDOW;
            devSupParms.timeout = TIMEOUT;
            devSupParms.respond2Writes = <span style="font-weight: bold; font-size: 14pt">-1</span>;
        }
        return 0;
    }
    </pre>
    The <span style="font-weight: bold; font-size: 14pt">bold</span> values
    are unique to your implementation. All the rest should appear exactly as
    shown above.</li>
  <li>Remove any report function.</li>
  <li>(Optional) Update copyright/license comments.</li>
</ol>

<h2>3. Modify instrument support database definition file</h2>
<ol>
  <li>Check your instrument support database definition file and see if it
    contains an entry for analog-in (ai) record device support. Add such an
    entry if the file does not already contain one.</li>
</ol>

<h2>4. (Optional) Create an example database</h2>
<ol>
  <li>Records should adopt the following conventions:
    <ul>
      <li>All record names should begin with $(P).</li>
      <li>All GPIB INP/OUT fields should specify the link value as L$(L).</li>
      <li>All GPIB INP/OUT fields should specify the address value as
      A$(A).</li>
    </ul>
    If your instrument already has an associated database file (or files) it
    may be useful to adapt it to follow these conventions.</li>
</ol>
</body>
</html>
